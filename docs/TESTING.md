# テストドキュメント

## 概要

このプロジェクトでは、認証機能を中心とした自動テストを実装しています。

## テストの種類

### 1. ユニットテスト (Unit Tests)

**目的**: 個々の関数やモジュールが正しく動作することを検証

**対象**:

- パスワードハッシュ化 (`hashPassword`)
- パスワード検証 (`verifyPassword`)
- パスワード強度チェック (`validatePassword`)
- メールアドレス検証 (`validateEmail`)

**実行方法**:

```bash
bun run test:unit
```

**監視モード**:

```bash
bun run test:unit:watch
```

**テストファイル**: `tests/unit/lib/utils.test.ts`

### 2. E2E テスト (End-to-End Tests)

**目的**: ユーザーが実際にブラウザで操作する流れを自動でテスト

**対象**:

- 権限表示テスト
  - 一般ユーザーには管理者専用 UI が表示されない
  - 管理者には管理者専用 UI が表示される
- ログアウト機能

**実行方法**:

```bash
bun run test:e2e
```

**UI モード（視覚的に確認）**:

```bash
bun run test:e2e:ui
```

**テストファイル**: `tests/e2e/permissions.test.ts`

## テストツール

### Jest

- **用途**: ユニットテスト
- **特徴**: 高速、シンプル
- **設定ファイル**: `jest.config.js`

### Playwright

- **用途**: E2E テスト
- **特徴**: クロスブラウザ対応、自動待機機能
- **設定ファイル**: `playwright.config.ts`
- **ブラウザ**: Chromium, Firefox, WebKit

## テストの構成

```
tests/
  ├── unit/
  │   └── lib/
  │       └── utils.test.ts      # ユーティリティ関数のテスト
  └── e2e/
      └── permissions.test.ts    # 権限表示のE2Eテスト
```

## カバレッジ

カバレッジレポートの生成:

```bash
bun run test:unit -- --coverage
```

## CI/CD での実行

### テストの実行方法

#### すべてのテストを実行

```bash
bun run test
```

このコマンドは、ユニットテストと E2E テストの両方を実行します。

#### 個別に実行

- ユニットテストのみ: `bun run test:unit`
- E2E テストのみ: `bun run test:e2e`

### ローカル環境での準備

#### E2E テストの実行

**テスト専用データベースを使用**

E2E テストは、開発環境とは独立したテスト専用データベースを使用します。

1. `.env.local`にテスト用データベースの URL を設定：

   ```env
   TEST_DATABASE_URL="postgresql://user:password@localhost:5432/test_database"
   ```

2. テストを実行：
   ```bash
   bun run test:e2e
   ```

これにより、以下のことが行われます：

- テスト用データベースにテストユーザーが自動作成される
- 開発環境のデータベースに影響を与えない
- テスト後はクリーンな状態になる

### 注意事項

**ユニットテスト**:

- データベースに依存しない
- モックを使用可能
- 高速に実行される

**E2E テスト**:

- 実際のブラウザを使用して操作をシミュレート
- テスト専用 PostgreSQL データベースを使用（開発環境とは独立）
- テスト用のユーザーアカウントは自動作成される
- 実行に時間がかかる

**テスト専用データベース**:

- `.env.local`に`TEST_DATABASE_URL`を設定することで、テスト用の独立したデータベースを使用できます
- テストユーザー（`admin@example.com`, `user@example.com`）は自動で作成され、テスト実行前にセットアップされます

## トラブルシューティング

### ユニットテストが失敗する

- `bun install` を実行して依存関係を再インストール
- キャッシュをクリア: `bun run test -- --clearCache`

### E2E テストが失敗する

- 開発用データベースにテストユーザーを作成
- 開発サーバーが起動していることを確認（テストは自動で起動します）
- ブラウザが正しくインストールされているか確認 (`bunx playwright install`)

## 今後の拡張

### 実装予定

- [ ] ログイン/ログアウトの統合テスト
- [ ] パスワードリセット機能の E2E テスト
- [ ] API エンドポイントの統合テスト
- [ ] セキュリティテスト（SQL インジェクション、XSS 対策など）

### テスト追加のベストプラクティス

- 各機能追加時にテストを並行して作成
- バグ修正時は回帰テストを追加
- テストケースは明確で理解しやすい名前にする
- テストは独立して動作するように設計
