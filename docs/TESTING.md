# テストドキュメント

## 概要

このプロジェクトでは、認証機能を中心とした自動テストを実装しています。

## テストの種類

### 1. ユニットテスト (Unit Tests)

**目的**: 個々の関数やモジュールが正しく動作することを検証

**対象**:
- パスワードハッシュ化 (`hashPassword`)
- パスワード検証 (`verifyPassword`)
- パスワード強度チェック (`validatePassword`)
- メールアドレス検証 (`validateEmail`)

**実行方法**:
```bash
bun run test
```

**監視モード**:
```bash
bun run test:watch
```

**テストファイル**: `tests/unit/lib/utils.test.ts`

### 2. E2Eテスト (End-to-End Tests)

**目的**: ユーザーが実際にブラウザで操作する流れを自動でテスト

**対象**:
- 権限表示テスト
  - 一般ユーザーには管理者専用UIが表示されない
  - 管理者には管理者専用UIが表示される
- ログアウト機能

**実行方法**:
```bash
bun run test:e2e
```

**UIモード（視覚的に確認）**:
```bash
bun run test:e2e:ui
```

**テストファイル**: `tests/e2e/permissions.test.ts`

## テストツール

### Jest
- **用途**: ユニットテスト
- **特徴**: 高速、シンプル
- **設定ファイル**: `jest.config.js`

### Playwright
- **用途**: E2Eテスト
- **特徴**: クロスブラウザ対応、自動待機機能
- **設定ファイル**: `playwright.config.ts`
- **ブラウザ**: Chromium, Firefox, WebKit

## テストの構成

```
tests/
  ├── unit/
  │   └── lib/
  │       └── utils.test.ts      # ユーティリティ関数のテスト
  └── e2e/
      └── permissions.test.ts    # 権限表示のE2Eテスト
```

## カバレッジ

カバレッジレポートの生成（Jest）:
```bash
bun run test -- --coverage
```

## CI/CDでの実行

### ローカル環境
1. データベースが起動していることを確認
2. テスト用ユーザーが作成されていることを確認
3. `bun run test` でユニットテストを実行
4. `bun run test:e2e` でE2Eテストを実行

### 注意事項

**ユニットテスト**:
- データベースに依存しない
- モックを使用可能
- 高速に実行される

**E2Eテスト**:
- 実際のデータベースとブラウザを使用
- テスト用のユーザーアカウントが必要
- 実行に時間がかかる

**テストユーザーの準備**:
テストを実行する前に、以下のユーザーアカウントが必要です：
- `user@example.com` (パスワード: `userpassword123`) - 一般ユーザー
- `admin@example.com` (パスワード: `adminpassword123`) - 管理者

必要に応じて、`create-admin`スクリプトを使用して作成してください。

## トラブルシューティング

### ユニットテストが失敗する

- `bun install` を実行して依存関係を再インストール
- キャッシュをクリア: `bun run test -- --clearCache`

### E2Eテストが失敗する

- 開発サーバーが起動していることを確認 (`bun run dev`)
- テスト用ユーザーが作成されていることを確認
- ブラウザが正しくインストールされているか確認 (`bunx playwright install`)

## 今後の拡張

### 実装予定
- [ ] ログイン/ログアウトの統合テスト
- [ ] パスワードリセット機能のE2Eテスト
- [ ] APIエンドポイントの統合テスト
- [ ] セキュリティテスト（SQLインジェクション、XSS対策など）

### テスト追加のベストプラクティス
- 各機能追加時にテストを並行して作成
- バグ修正時は回帰テストを追加
- テストケースは明確で理解しやすい名前にする
- テストは独立して動作するように設計

